{% extends "base.html" %}

{% load static %}

<div class="row">
    <div class="col-1">
        <span class="glyphicon glyphicon-user"></span>
    </div>
    <div class="col-11">
        <h5>{{ comment.user.first_name }} {{comment.user.last_name}}</h5>
        <p>{{ comment.comment_text }}</p>
    </div>
</div>

<script type="text/javascript">

    {% block jquery %}

    function fetchComments() {
        showLoader()
        $.ajax({
            method: 'GET',
            url: '{% url "api:chapterComments" %}',
            data: {
                'chapter_content_slug': '{{ chapter_content.slug }}'
            },
            success: function (data) {
                var com = document.getElementById('comments-list')
                for (var i = 0; i < data.length; i++) {
                    com.innerHTML += '<div class="row"><div class="col-1"><span class="glyphicon glyphicon-user"></span></div><div class="col-11"><h5>' + data[i].first_name + ' ' + data[i].last_name + '</h5><p>' + data[i].comment_text + '</p></div></div>'
                }
                hideLoader()
            },
            error: function (error) {
            }
        })
    }

    fetchComments()

    if (performance.navigation.type == performance.navigation.TYPE_RELOAD) {

    } else {
        $.ajax({
            url: '{% url "api:increase_view" %}',
            method: "POST",
            data: {
                'slug': '{{slug}}',
                'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
            },
            success: function (data) {
            }, error: function (error) {
            },
        })
    }

    function updateLikes(likes, success) {
        if (success) {
            $('#like-btn').addClass('liked');
            document.getElementById('likeImg').src = "/static/images/heart_active.svg";
        } else {
            $('#like-btn').removeClass('liked');
            document.getElementById('likeImg').src = "/static/images/heart.svg";
        }
        $('#likes').text(likes)
    }

    function showLoader() {
        var loader = document.getElementById('comment_loader')
        loader.style.display = 'block'
    }

    function hideLoader() {
        var loader = document.getElementById('comment_loader')
        loader.style.display = 'none'
    }

    function updateComment(user, comment) {
        var com = document.getElementById('comments-list')
        hideLoader()
        com.innerHTML = '<div class="row"><div class="col-1"><span class="glyphicon glyphicon-user"></span></div><div class="col-11"><h5>{{user.first_name}} {{user.last_name}}</h5><p>' + comment + '</p></div></div>' + com.innerHTML
        document.getElementById('comment').value = ''
    }

    $("#comment-btn").click(function (e) {
        e.preventDefault()
        showLoader()
        var this_ = $(this)

        var commentUrl = this_.attr('data-comment')
        var slug = this_.attr('data-comment-slug')
        $.ajax({
            url: commentUrl,
            method: "POST",
            data: {
                'slug': slug,
                'comment_text': document.getElementById('comment').value,
                'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
            },
            success: function (data) {
                if (data.success) {
                    if (data.comment != "") {
                        updateComment(data.user, data.comment)
                    } else {
                        // alert('Please enter a comment')
                        // hideLoader()
                    }
                } else {

                }
            }, error: function (error) {
            },
        })
    })

    $("#like-btn").click(function (e) {
        e.preventDefault();
        var this_ = $(this)
        var user = this_.attr('data-user')
        if (user) {
            var likeUrl = this_.attr('data-href')
            var slug = this_.attr('data-slug')
            var likes = this_.attr('data-likes')
            $.ajax({
                url: likeUrl,
                method: "POST",
                data: {
                    'slug': slug,
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (data) {
                    updateLikes(data.likes, data.success)
                }, error: function (error) {
                    alert(error)
                },

            })
        } if (user == "False") {
            alert('You need to login to like this post')
        }
    })
    {% endblock %}
</script>

{% block content %}
<link rel="stylesheet" href="{% static 'blogs/css/indi_blog.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<div class="center">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'blogs:index' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'blogs:sub_topic' slug=slug %}">{{ title }}</a></li>
        <li class="breadcrumb-item active">{{ chapter_content.heading | title }}</li>
    </ol>
</div>
<div class="row">
    <div class="col-sm-12 col-md-12 col-lg-2 container"></div>
    <div class="col-sm-12 col-md-12 col-lg-8 container">
        <h2>{{ chapter_content.heading }}</h2>
    </div>
    <div class="col-sm-12 col-md-12 col-lg-2"></div>
</div>


<div class="row">
    <div class="col-sm-12 col-md-12 col-lg-2 container">
        <ul class="list-group list-group-flush">
            {% for chapter in chapters %}
            {% if chapter.slug == chapter_content.slug %}
            <a class="list-group-item list-group-item-action" id="selected"
                href="{% url 'blogs:chapter_post' slug=slug chapter=chapter.slug %}">{{ chapter.heading }}</a>
            {% else %}
            <a class="list-group-item list-group-item-action" id="listItem"
                href="{% url 'blogs:chapter_post' slug=slug chapter=chapter.slug %}">{{ chapter.heading }}</a>
            {% endif %}
            {% endfor %}
        </ul>
    </div>


    <!-- 
        The image height and width to be reduced to 50% 
        The container width and height to be reduced to 50%
    -->


    <div class="col-sm-12 col-md-12 col-lg-8 container" style="margin-top: 0px;">

        <!-- for short desc -->
        <div class="card-panel">
            <p>
                ng essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing
                Lorem Ipsum passages, and more recently with desktoypesetting industry. Lorem Ipsum has been the
                industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and
                scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap
                into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the
                release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktoypesetting
                industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown
                printer took a galley of type and scrambled it to make a type specimen book. It has survived not only
                five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was
                popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more
                recently with desktoypesetting industry. Lorem Ipsum has been the industry's standard dummy text ever
                since the 1500s, when an unknown
            </p>
        </div>

        <p style="margin-top: 50px;" class="container">
            {{ chapter_content.content | safe | escape }}
        </p>
        
        {% if chapter_content.youtube_link and chapter_content.youtube_link.strip %}
        <div style="margin-top: 150px;">
            <iframe src="{{ chapter_content.youtube_link }}" frameborder="0" allowfullscreen id="video"></iframe>
        </div>
        {% else %}
            <div>
                Video is Not available!
            </div>
        {% endif %}
    </div>

    <div class="col-sm-12 col-md-12 col-lg-2">
        <!-- <ul class="list-group list-group-flush">
            <a class="list-group-item list-group-item-action" id="selected" href="">Some alksjcn</a>
        </ul> -->
    </div>
</div>

<div class="row" style="margin-top: 150px; height: 100px;">
    <div class="col-sm-12 col-md-6 col-lg-8 center-div">
        <hr>
        <div class="row valign-wrapper">
            <div class="col-sm-2">
                <img src="https://images.unsplash.com/photo-1597887160393-996b475edd75?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=500&q=60"
                    alt="" class="circle responsive-img">
            </div>
            <div class="col-sm-10">
                <div>
                    <a href="{% url 'author:author_page' slug='some' %}" target="_blank" class="font-weight-bold">
                        Name of the author
                    </a>
                </div>
                <div>
                    <span class="black-text">
                        {{ author.description }}
                    </span>
                </div>
            </div>
        </div>
        <hr>
    </div>
</div>

<!-- <div class="row">
    <div class="col-sm-12 col-md-6 col-lg-8 container center">
       
    </div>
</div> -->


<div class="row" id="commentsContainer" style="margin-top: 150px;">
    <div class="col-sm-12 col-md-6 col-lg-8 container">
        <div class="row no-gutters">
            <div class="col-6">
                <h4>Comments</h4>
            </div>
            <div class="col-6">
                <div class="row right vertical-center">
                    {% csrf_token %}
                    <i onclick="" class="icon-btn" id="like-btn" data-user="{{ request.user.is_authenticated }}"
                        data-href='{{ chapter_content.get_like_url }}' data-slug={{chapter_content.slug}}
                        data-likes={{chapter_content.no_of_likes}}>
                        {% if not has_liked %}
                        <img id="likeImg" src="/static/images/heart.svg" style="width: 30px; height: 30px;">
                        {% else %}
                        <img id="likeImg" src="/static/images/heart_active.svg" style="width: 30px; height: 30px;">
                        {% endif %}
                    </i>
                    <p id="likes">{{ chapter_content.like_count }}</p>
                </div>
            </div>
        </div>

        {% if request.user.is_authenticated %}
        <div class="input-field">
            {% csrf_token %}
            <input type="text" class="validate" id="comment" placeholder="Enter your comment" autocomplete="off"
                onkeyup="stoppedTyping(this.value)">
            <input type="button" value="Submit" id="comment-btn" data-comment="{{ chapter_content.get_comment_url }}"
                data-comment-slug={{chapter_content.slug}} class="btn" disabled>
        </div>
        {% else %}
        <div class="row">
            <div class="col-10">
                <p>Login to comment</p>
            </div>
            <div class="col-2">
                <div class="row">
                    <div class="col-6 center-div">
                        <a id="googleLoginCmt"
                            google-href-cmt="{% url 'social:begin' 'google-oauth2' %}?next={{request.path}}"
                            class="icon-btn">
                            <img src="/static/images/google-logo.svg" alt="googleLogo" width="50px" height="50px" />
                        </a>
                    </div>
                    <div class="col-6 center-div">
                        <a id="githubLoginCmt" github-href-cmt="{% url 'social:begin' 'github' %}?next={{request.path}}"
                            class="icon-btn">
                            <img src="/static/images/github-logo.svg" alt="githubLogo" width="50px" height="50px" />
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        <div id="comments-list" style="margin-top: 50px;">
            <div class="spinner-border text-primary center" role="status" id='comment_loader' style="display: none;">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </div>
</div>
<script>



    if (window.history.replaceState) {
        window.history.replaceState(null, null, window.location.href);
    }

    function stoppedTyping(value) {
        if (value.length > 0) {
            document.getElementById('comment-btn').disabled = false;
        } else {
            document.getElementById('comment-btn').disabled = true;
        }
    }

    document.getElementById('googleLoginCmt').onclick = function () {
        var url = this.getAttribute('google-href-cmt')
        window.open(url, "_self")
    };

    document.getElementById('githubLoginCmt').onclick = function () {
        var url = this.getAttribute('github-href-cmt')
        window.open(url, "_self")
    };



</script>



{% endblock content %}